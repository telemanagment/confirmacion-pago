<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Confirmación de Pago</title>
  <script>
    function obtenerParametros() {
      const params = new URLSearchParams(window.location.search);
      return {
        token: params.get("token"),
        chat_id: params.get("chat_id"),
        cedula: params.get("cedula"),
        nombre: params.get("nombre"),
        direccion: params.get("direccion"),
        total: params.get("total"),
        idFactura: params.get("idFactura"),
        meses: params.get("meses")
      };
    }

    async function confirmarPago() {
      const datos = obtenerParametros();

      // Validación de parámetros obligatorios
      if (!datos.token || !datos.chat_id || !datos.cedula || !datos.nombre || !datos.direccion || !datos.total || !datos.idFactura || !datos.meses) {
        document.body.innerHTML = "<h2 style='color:red;'>❌ Faltan parámetros en la URL.</h2>";
        return;
      }

      const mensaje = `✅ EL TECNICO CONFIRMÓ el pago de la factura ${datos.idFactura} CON CÉDULA ${datos.cedula} A NOMBRE DE ${datos.nombre} DIRECCIÓN ${datos.direccion} POR $${datos.total} MESES: ${datos.meses}. POR FAVOR ENTREGAR EL $ EN LA OFICINA`;

      const url = `https://api.telegram.org/bot${datos.token}/sendMessage?chat_id=${datos.chat_id}&text=${encodeURIComponent(mensaje)}`;

      try {
        const boton = document.getElementById("btnConfirmar");
        boton.disabled = true;
        boton.innerText = "✅ Confirmado";

        await fetch(url);
        setTimeout(() => window.close(), 1000); // Cierra la página tras 1 segundo
      } catch (e) {
        alert("Ocurrió un error al enviar la confirmación.");
        console.error(e);
      }
    }

    window.onload = confirmarPago;
  </script>
</head>
<body>
  <h2>✅ Confirmando el pago...</h2>
  <button id="btnConfirmar" onclick="confirmarPago()">Reintentar</button>
</body>
</html>